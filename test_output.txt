
> univesp-extension@2.5.3 test
> jest

FAIL tests/integration/addCourse.integration.test.js
  Integration: Add Course Manual Flow
    ✕ should add a course manually and display it in the list (571 ms)

  ● Integration: Add Course Manual Flow › should add a course manually and display it in the list

    expect(received).toBe(expected) // Object.is equality

    Expected: 1
    Received: 0

      93 |
      94 |     const listItems = document.querySelectorAll('#itemList li');
    > 95 |     expect(listItems.length).toBe(1);
         |                              ^
      96 |     expect(listItems[0].textContent).toContain('Matéria Teste Integração');
      97 |   });
      98 | });

      at Object.toBe (tests/integration/addCourse.integration.test.js:95:30)

PASS tests/components/BatchImportModal_Render.test.js
  BatchImportModal Render Logic
    ✓ Should sort terms descending (newest first) and render courses with checkboxes (19 ms)
    ✓ Should handle empty terms gracefully (3 ms)

PASS tests/integration/navigation.integration.test.js
  Integration: Navigation Flow
    ✓ should navigate between tabs using TopNav (71 ms)
    ✓ should handle programmatic navigation (23 ms)

PASS tests/integration/scrapeCourse.integration.test.js
  Integration: Scrape Course Flow
    ✓ should scrape current tab and save course (181 ms)
    ✓ should handle scrape failure gracefully (131 ms)

PASS tests/storage.test.js
  Storage - CRUD de Cursos
    loadItems()
      ✓ Deve carregar lista vazia por padrão (6 ms)
      ✓ Deve carregar cursos existentes (2 ms)
      ✓ Deve chamar callback com dados corretos (3 ms)
    saveItems()
      ✓ Deve salvar lista de cursos (3 ms)
      ✓ Deve executar callback após salvar (2 ms)
      ✓ Deve funcionar sem callback (2 ms)
    addItem()
      ✓ Deve adicionar curso com sucesso (3 ms)
      ✓ Deve gerar ID único usando Date.now() (2 ms)
      ✓ Deve rejeitar duplicata (mesma URL) (3 ms)
      ✓ Deve incluir weeks vazio por padrão (2 ms)
      ✓ Deve passar weeks customizado (3 ms)
      ✓ Deve persistir termName passado via options (3 ms)
    addItemsBatch()
      ✓ Deve adicionar múltiplos cursos (3 ms)
      ✓ Deve gerar IDs únicos para cada curso (2 ms)
      ✓ Deve ignorar duplicatas (2 ms)
      ✓ Deve retornar contadores corretos (2 ms)
      ✓ Deve lidar com lista vazia (2 ms)
      ✓ Deve não salvar se todos são duplicatas (2 ms)
      ✓ Deve persistir termName nos itens do lote (2 ms)
    deleteItem()
      ✓ Deve remover curso existente (2 ms)
      ✓ Deve lidar com ID inexistente (2 ms)
      ✓ Deve executar callback (1 ms)
    updateItem()
      ✓ Deve atualizar curso existente (2 ms)
      ✓ Deve mesclar updates com dados existentes (2 ms)
      ✓ Deve lidar com ID inexistente sem falhar (2 ms)
      ✓ Deve executar callback mesmo com ID inexistente (1 ms)
    clearItems()
      ✓ Deve limpar todos os cursos (1 ms)
      ✓ Deve chamar saveItems com array vazio (1 ms)
      ✓ Deve executar callback (1 ms)

PASS tests/imports.test.js
  Verificação de Integridade de Arquivos e Imports
    ✓ Arquivo deve existir: manifest.json (2 ms)
    ✓ Arquivo deve existir: popup/popup.html (1 ms)
    ✓ Arquivo deve existir: popup/popup.js (1 ms)
    ✓ Arquivo deve existir: popup/popup.css (1 ms)
    ✓ Arquivo deve existir: sidepanel/sidepanel.html (1 ms)
    ✓ Arquivo deve existir: sidepanel/sidepanel.js (1 ms)
    ✓ Arquivo deve existir: sidepanel/styles/global.css (1 ms)
    ✓ Arquivo deve existir: sidepanel/styles/layout.css (1 ms)
    ✓ Arquivo deve existir: sidepanel/styles/components/nav.css (1 ms)
    ✓ Arquivo deve existir: sidepanel/styles/components/card.css (1 ms)
    ✓ Arquivo deve existir: sidepanel/styles/components/modal.css (1 ms)
    ✓ Arquivo deve existir: sidepanel/styles/components/button.css (1 ms)
    ✓ Arquivo deve existir: sidepanel/styles/views/home.css (1 ms)
    ✓ Arquivo deve existir: sidepanel/styles/views/courses.css (1 ms)
    ✓ Arquivo deve existir: sidepanel/styles/views/settings.css (1 ms)
    ✓ Arquivo deve existir: sidepanel/logic/scraper.js (1 ms)
    ✓ Arquivo deve existir: sidepanel/logic/storage.js (1 ms)
    ✓ Arquivo deve existir: sidepanel/logic/tabs.js
    ✓ Arquivo deve existir: sidepanel/logic/batchScraper.js (1 ms)
    ✓ Arquivo deve existir: sidepanel/components/Modals/BatchImportModal.js (1 ms)
    ✓ Arquivo deve existir: sidepanel/components/Modals/Modal.js
    ✓ Arquivo deve existir: sidepanel/components/Items/CourseItem.js
    ✓ Arquivo deve existir: sidepanel/components/Items/WeekItem.js (1 ms)
    ✓ Arquivo deve existir: sidepanel/views/FeedbackView.js (1 ms)
    ✓ Arquivo deve existir: sidepanel/views/HomeView.js (1 ms)
    ✓ Arquivo deve existir: sidepanel/views/CoursesView.js (1 ms)
    ✓ Arquivo deve existir: sidepanel/views/CourseDetailsView.js (1 ms)
    ✓ Arquivo deve existir: sidepanel/views/SettingsView.js
    ✓ Arquivo deve existir: sidepanel/utils/statusManager.js (1 ms)
    ✓ Arquivo deve existir: shared/utils/settings.js (1 ms)
    ✓ Arquivo deve existir: scripts/content.js (1 ms)
    ✓ Deve conseguir importar módulos JS sem erro de sintaxe (14 ms)
    ✓ manifest.json deve ter estrutura válida (4 ms)
    ✓ manifest.json deve ter permissões mínimas necessárias (3 ms)

PASS tests/raManager.test.js
  RaManager
    getRaFromEmail
      ✓ Should extract RA from email (2 ms)
      ✓ Should return unchanged if no @ (1 ms)
      ✓ Should return empty string for null/undefined (1 ms)
    prepareCredentials
      ✓ Should return valid object for correct input (1 ms)
      ✓ Should return error if RA is empty (1 ms)
      ✓ Should clean inputs (1 ms)

PASS tests/utils/courseGrouper.test.js
  courseGrouper Utility
    ✓ Should group courses by term and sort groups descending (3 ms)
    ✓ Should handle empty list (1 ms)

PASS tests/batchScraper.test.js
  Lógica - Batch Scraper
    scrapeAvailableTerms
      ✓ Deve retornar termos agrupados corretamente por Display ID (12 ms)
      ✓ Deve lidar com falha no script (2 ms)
    processSelectedCourses
      ✓ Deve processar cursos selecionados (Deep Scraping) (3 ms)
      ✓ Deve retornar array vazio em caso de erro (2 ms)

PASS tests/integration/batchImport.integration.test.js
  Integration: Batch Import Flow
    ✓ should scrape multiple courses and save them (55 ms)
    ✓ should handle incorrect page (24 ms)

PASS tests/tabs.test.js
  Lógica - Troca de Abas
    ✓ Deve alternar para aba correspondente ao course_id exatamente (10 ms)
    ✓ Deve usar startsWith se course_id não for encontrado (3 ms)
    ✓ Deve criar nova aba se nenhuma correspondência for encontrada (2 ms)
    ✓ Deve priorizar content_id exato quando múltiplas abas tiverem o mesmo course_id (3 ms)
    ✓ Deve lidar com URL sem course_id ou content_id usando startsWith (2 ms)
    ✓ Deve focar na janela ao alternar abas (2 ms)
    ✓ Deve criar nova aba quando query retornar array vazio (1 ms)

PASS tests/storage_persistence.test.js
  Storage Logic - Persistence & v2.4.1 Features
    ✓ addItemsBatch should persist termName (8 ms)
    ✓ addItem should accept options object with termName (5 ms)
    ✓ addItem should work with old signature (backward compatibility) (2 ms)

PASS tests/utils/termParser.test.js
  termParser Utility
    ✓ Should parse standard name format "2025/2 - 4º Bimestre" (2 ms)
    ✓ Should parse ID-like format "2026S1B2" inside a string (6 ms)
    ✓ Should return defaults for unknown format (1 ms)
    ✓ Should handle object input
    ✓ Should prioritize termName property if present

PASS tests/logic.test.js
  Testes de Lógica - Scraper
    ✓ scrapeWeeksFromTab deve chamar executeScript corretamente (5 ms)
    ✓ scrapeWeeksFromTab deve lidar com retorno vazio (1 ms)
    ✓ scrapeWeeksFromTab deve mesclar resultados de múltiplos frames (3 ms)
    ✓ scrapeWeeksFromTab deve remover duplicatas baseado em URL (1 ms)
    ✓ scrapeWeeksFromTab deve ordenar semanas por número (1 ms)
    ✓ scrapeWeeksFromTab deve ignorar semanas sem URL (1 ms)
    ✓ scrapeWeeksFromTab deve lidar com erro no executeScript (2 ms)
    ✓ scrapeWeeksFromTab deve lidar com result undefined (1 ms)
    ✓ scrapeWeeksFromTab deve lidar com weeks não sendo array (2 ms)
    ✓ scrapeWeeksFromTab deve usar primeiro título não-null encontrado (1 ms)

PASS tests/settings.test.js
  Settings - Formatação de Email e Domínio
    formatEmail()
      ✓ Deve formatar RA simples com domínio que já tem @ (10 ms)
      ✓ Deve adicionar @ ao domínio se não tiver (6 ms)
      ✓ Deve remover @ do RA se já estiver incluído (2 ms)
      ✓ Deve fazer trim em RA com espaços (1 ms)
      ✓ Deve fazer trim no domínio com espaços (1 ms)
      ✓ Deve lidar com RA e domínio ambos precisando de limpeza (1 ms)
    extractRa()
      ✓ Deve extrair RA de email completo
      ✓ Deve retornar RA se já estiver sem @
      ✓ Deve retornar string vazia para null (1 ms)
      ✓ Deve retornar string vazia para undefined
      ✓ Deve retornar string vazia para string vazia
      ✓ Deve lidar com múltiplos @ no email (1 ms)
    resolveDomain()
      ✓ Deve priorizar customDomain se fornecido (1 ms)
      ✓ Deve extrair domínio de userEmail se não há customDomain
      ✓ Deve retornar DEFAULT_DOMAIN se ambos são null
      ✓ Deve retornar DEFAULT_DOMAIN se userEmail não tem @ (1 ms)
      ✓ Deve retornar DEFAULT_DOMAIN se userEmail é string vazia
      ✓ Deve lidar com múltiplos @ no userEmail
      ✓ Deve ignorar userEmail se customDomain está presente (1 ms)
    CONSTANTS
      ✓ Deve ter DEFAULT_DOMAIN definido corretamente
      ✓ DEFAULT_DOMAIN deve ser uma string (1 ms)
      ✓ DEFAULT_DOMAIN deve começar com @

PASS tests/domainManager.test.js
  DomainManager
    getCurrentDomain
      ✓ Should return custom domain if provided (5 ms)
      ✓ Should extract domain from email if no custom domain (1 ms)
      ✓ Should return default domain if nothing provided (1 ms)
    getDefaultDomain
      ✓ Should return constant default domain (9 ms)

Test Suites: 1 failed, 15 passed, 16 total
Tests:       1 failed, 134 passed, 135 total
Snapshots:   0 total
Time:        7.672 s, estimated 8 s
Ran all test suites.
